<!DOCTYPE html/>
<html>
<head>
<title>Grouped Post | {{feed_title}}</title>
{% include "head-data.html" %}
    <script type="text/javascript" src="/static/js/google-charts.js"></script>
    <script type="text/javascript" src="/static/js/d3.v6.min.js"></script>
    <style>
    .sentence-group { display:inline; margin:0 1px; padding:2px 4px; border-radius:3px; transition:background-color 0.2s ease; cursor: pointer; }
    .sentence-group:hover { filter: brightness(0.9); }
    .sentence-group.highlighted { outline: 2px solid #ff9800; box-shadow: 0 0 5px rgba(255, 152, 0, 0.8); font-weight: bold; }
    .post-section { margin-bottom: 25px; padding: 15px; background-color: #fafafa; border-radius: 8px; border: 1px solid #e0e0e0; }
    .post-header { margin-bottom: 12px; }
    .post-content { margin-top: 8px; }
    .post-label { display: inline-block; padding: 4px 12px; background-color: #4285f4; color: white; border-radius: 16px; font-size: 12px; font-weight: bold; margin-bottom: 8px; }
    .post-divider { height: 2px; background: linear-gradient(90deg, transparent, #4285f4, transparent); margin: 6px 0; }
        .sentence { display:inline; }
        #segments_tree { font-family:monospace; font-size:13px; line-height:1.25em; padding:8px; color:#000; border-radius:6px; max-height:400px; overflow:auto; }
        .seg-node { cursor:pointer; white-space:nowrap; }
        .seg-node .label { padding:2px 4px; border-radius:4px; }
        .seg-meta { opacity:0.7; font-size:11px; margin-left:4px; }
        .legend { margin:10px 0; display:flex; flex-wrap:wrap; gap:6px; }
        .legend-item { display:flex; align-items:center; gap:4px; padding:2px 6px; border-radius:4px; font-size:12px; }
        .legend-color { width:14px; height:14px; border-radius:3px; border:1px solid #999; }
        .depth-0 .label { font-weight:bold; font-size:14px; }
        .collapsed > .children { display:none; }
        .children { margin-left:18px; border-left:1px dashed #555; padding-left:6px; }
        .toggle { color:#6cf; margin-right:4px; }
    .range-highlight { outline:2px solid #ff9800; box-shadow:0 0 3px 2px rgba(255,152,0,0.6); }
    .pulse { animation:pulse-bg 1.5s ease-in-out 1; }
    @keyframes pulse-bg { 0%{outline-color:#ff9800;} 50%{outline-color:#ffc107;} 100%{outline-color:#ff9800;} }
    .sticky-sidebar { position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; z-index: 10; background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 6px; backdrop-filter: blur(5px); }
    .topic-item { margin: 4px 0; padding: 8px; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; }
    .topic-item:hover { filter: brightness(0.9); transform: translateX(2px); }
    .topic-item.active { outline: 2px solid #333; }
    .topic-count { font-size: 11px; opacity: 0.7; margin-left: 4px; }
    .section-header { font-weight: bold; margin: 15px 0 8px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd; }
      </style>
</head>
<body>
{% import 'main-menu.html' as menu with context %}{% import 'global-status.html' as g_status with context %}

<div id="global_tools">
    <div class="left_half">
        <div id="link_on_root" class="global_tools_button">
            <a href="/">main</a>
        </div>
        <div id="help_button" class="global_tools_button">
            <a href="#">help</a>
        </div>
    </div>
    <div class="right_half">
        <div id="player_block" class="global_tools_button"></div>
        <div id="posts_stat" class="global_tools_button"></div>
        <div id="read_all" class="global_tools_button"></div>
        <div id="show_all" class="global_tools_button"></div>
        {{ g_status.global_status() }}
        {{ menu.settings_menu() }}
    </div>
</div>

<div class="page">
    <h2>Posts {{post_id}} - {{feed_title}}</h2>
    
    {% if feed_title and feed_title != "Processing..." %}
    <div style="padding: 15px; background-color: #e8f5e9; border-radius: 5px; margin-bottom: 20px;">
        <p style="margin: 0; color: #2e7d32;">
            <strong>Combined view:</strong> {{ feed_title }}
            {% if sentences|length > 0 %}
            <span style="margin-left: 10px; font-weight: normal;">
                ({{ sentences|length }} sentences from {{ groups|length }} topics)
            </span>
            {% endif %}
        </p>
    </div>
    {% endif %}

    <div style="display:flex; gap:20px; flex-wrap:wrap;">
      <div style="flex:2 1 600px; min-width:400px;">
        <h3>Posts</h3>
        <div id="grouped_posts">
            {% if posts|length > 0 %}
                {% for post in posts %}
                    <div class="post-section" data-post-id="{{ post.post_id }}">
                        <div class="post-header">
                            <span class="post-label">Post {{ post.post_id }}</span>
                            {% if post.feed_title %}
                                <span class="post-feed" style="margin-left: 10px; font-weight: normal; color: #666;">
                                    from {{ post.feed_title }}
                                </span>
                            {% endif %}
                            <div class="post-divider"></div>
                        </div>
                        <div class="post-content">
                            <div class="post-text" data-post-id="{{ post.post_id }}">{{ post.content|safe }}</div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-posts-message" style="padding: 20px; text-align: center; color: #666;">
                    No posts found or posts are still being processed.
                </div>
            {% endif %}
        </div>
      </div>
      <div style="flex:1 1 320px; min-width:280px;">
        <div class="sticky-sidebar">
          <div class="section-header">Topics/Chapters</div>
          <div id="topics_list"></div>
          
          {% if posts|length > 1 %}
          <div class="section-header" style="margin-top: 20px;">Posts</div>
          <div id="posts_list"></div>
          {% endif %}
        </div>
      </div>
    </div>
</div>

<script type="text/javascript">
    window.post_id = "{{post_id|default('')|string}}";
    window.feed_title = '{{feed_title|default('')|string}}';
    window.groups = {{groups|default({})|tojson}};
    window.group_colors = {{group_colors|default({})|tojson}};
    window.posts = {{posts|default([])|tojson}};
    window.sentences = {{sentences|default([])|tojson}};
    window.rss_settings = {{ user_settings|default({})|tojson }};
    window.hierarchical_segments = {{ hierarchical_segments|default([])|tojson }};
    window.post_to_index_map = {{ post_to_index_map|default({})|tojson }};
    window.has_grouped_data = {{ has_grouped_data|default(false)|tojson }};
    
    (function(){
        // Add data-post-id attributes to post sections
        document.querySelectorAll('#grouped_posts .post-section').forEach((section) => {
            const postId = section.getAttribute('data-post-id');
            if(postId) {
                section.setAttribute('data-post-index', window.post_to_index_map[postId]);
            }
        });
        
        // Add hover effects to post sections for better visual feedback
        document.querySelectorAll('#grouped_posts .post-section').forEach((section) => {
            section.addEventListener('mouseenter', () => {
                section.style.boxShadow = '0 2px 8px rgba(66, 133, 244, 0.2)';
            });
            section.addEventListener('mouseleave', () => {
                section.style.boxShadow = 'none';
            });
        });
        
        // If we have grouped data with sentences, wrap content in sentence spans
        if (window.has_grouped_data && window.sentences && window.sentences.length > 0) {
            wrapSentencesInContent();
        }
        
        // Build topics list
        const topicsList = document.getElementById('topics_list');
        const groupKeys = Object.keys(window.groups);
        
        if (groupKeys.length > 0) {
            groupKeys.forEach(groupName => {
                const sentenceIndices = window.groups[groupName];
                const color = window.group_colors[groupName] || '#4a6baf';
                const el = document.createElement('div');
                el.className = 'topic-item';
                el.style.backgroundColor = color + '40'; // add alpha
                el.style.borderLeft = '4px solid ' + color;
                
                // Display name and count
                const countLabel = window.has_grouped_data ? 
                    sentenceIndices.length + ' sentence(s)' : 
                    sentenceIndices.length + ' post(s)';
                el.innerHTML = '<span class="topic-name">' + escapeHtml(groupName) + '</span>' +
                               '<span class="topic-count">(' + countLabel + ')</span>';
                
                el.onclick = () => {
                    // Clear previous active state
                    document.querySelectorAll('.topic-item.active').forEach(item => {
                        item.classList.remove('active');
                    });
                    el.classList.add('active');
                    
                    if (window.has_grouped_data) {
                        // Highlight sentences for this topic
                        highlightSentences(sentenceIndices, color);
                    } else {
                        // Fallback: highlight post sections
                        highlightPosts(sentenceIndices, color);
                    }
                };
                topicsList.appendChild(el);
            });
        } else {
            topicsList.innerHTML = '<p style="color: #666; font-style: italic;">No topics available</p>';
        }
        
        // Build posts list (only shown when multiple posts)
        const postsList = document.getElementById('posts_list');
        if (postsList && window.posts.length > 1) {
            window.posts.forEach((post, idx) => {
                const el = document.createElement('div');
                el.className = 'topic-item';
                el.style.backgroundColor = '#4285f440';
                el.style.borderLeft = '4px solid #4285f4';
                el.innerHTML = '<span class="topic-name">Post ' + post.post_id + '</span>' +
                               '<span class="topic-count">(' + (post.feed_title || 'Unknown') + ')</span>';
                el.onclick = () => {
                    const section = document.querySelector('[data-post-id="' + post.post_id + '"]');
                    if (section) {
                        section.scrollIntoView({behavior: 'smooth', block: 'center'});
                        // Flash highlight
                        section.classList.add('range-highlight', 'pulse');
                        setTimeout(() => {
                            section.classList.remove('range-highlight', 'pulse');
                        }, 2000);
                    }
                };
                postsList.appendChild(el);
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function wrapSentencesInContent() {
            // Group sentences by post_id
            const sentencesByPost = {};
            window.sentences.forEach(sentence => {
                const postId = sentence.post_id;
                if (!sentencesByPost[postId]) {
                    sentencesByPost[postId] = [];
                }
                sentencesByPost[postId].push(sentence);
            });
            
            // For each post, wrap its content with sentence spans
            Object.keys(sentencesByPost).forEach(postId => {
                const postText = document.querySelector('.post-text[data-post-id="' + postId + '"]');
                if (!postText) return;
                
                const postSentences = sentencesByPost[postId];
                let content = postText.innerHTML;
                
                // Find colors for each sentence based on groups
                const sentenceColors = {};
                Object.keys(window.groups).forEach(groupName => {
                    const color = window.group_colors[groupName] || '#4a6baf';
                    window.groups[groupName].forEach(sentNum => {
                        sentenceColors[sentNum] = color;
                    });
                });
                
                // Sort sentences by length descending to avoid partial replacements
                const sortedSentences = [...postSentences].sort((a, b) => b.text.length - a.text.length);
                
                // Track which parts of content have been wrapped
                const wrappedRanges = [];
                
                sortedSentences.forEach(sentence => {
                    const sentText = sentence.text;
                    const sentNum = sentence.number;
                    const color = sentenceColors[sentNum] || '#f0f0f0';
                    
                    // Find the sentence in content (handle HTML)
                    // First try exact match
                    let idx = content.indexOf(sentText);
                    
                    if (idx === -1) {
                        // Try with normalized whitespace
                        const normalizedSent = sentText.replace(/\s+/g, ' ').trim();
                        const normalizedContent = content.replace(/\s+/g, ' ');
                        idx = normalizedContent.indexOf(normalizedSent);
                    }
                    
                    if (idx !== -1) {
                        // Check if this range overlaps with already wrapped ranges
                        const endIdx = idx + sentText.length;
                        const overlaps = wrappedRanges.some(range => 
                            (idx >= range.start && idx < range.end) || 
                            (endIdx > range.start && endIdx <= range.end)
                        );
                        
                        if (!overlaps) {
                            const before = content.substring(0, idx);
                            const after = content.substring(idx + sentText.length);
                            const wrapped = '<span class="sentence-group" data-sentence="' + sentNum + 
                                           '" style="background-color: ' + color + '40;">' + 
                                           sentText + '</span>';
                            content = before + wrapped + after;
                            
                            // Update wrapped ranges (accounting for added HTML)
                            const addedLength = wrapped.length - sentText.length;
                            wrappedRanges.forEach(range => {
                                if (range.start > idx) {
                                    range.start += addedLength;
                                    range.end += addedLength;
                                }
                            });
                            wrappedRanges.push({start: idx, end: idx + wrapped.length});
                        }
                    }
                });
                
                postText.innerHTML = content;
            });
            
            // Add click handlers to sentence spans
            document.querySelectorAll('.sentence-group').forEach(span => {
                span.addEventListener('click', function() {
                    const sentNum = parseInt(this.getAttribute('data-sentence'));
                    // Find which topic this sentence belongs to
                    let topicName = null;
                    Object.keys(window.groups).forEach(groupName => {
                        if (window.groups[groupName].includes(sentNum)) {
                            topicName = groupName;
                        }
                    });
                    if (topicName) {
                        // Simulate click on the topic
                        const topicItems = document.querySelectorAll('.topic-item');
                        topicItems.forEach(item => {
                            if (item.querySelector('.topic-name').textContent === topicName) {
                                item.click();
                            }
                        });
                    }
                });
            });
        }
        
        function highlightSentences(sentenceIndices, color) {
            // Clear previous highlights
            document.querySelectorAll('.sentence-group.highlighted').forEach(span => {
                span.classList.remove('highlighted');
            });
            
            // Highlight sentences in the list
            sentenceIndices.forEach(sentNum => {
                const span = document.querySelector('.sentence-group[data-sentence="' + sentNum + '"]');
                if (span) {
                    span.classList.add('highlighted');
                }
            });
            
            // Scroll to the first highlighted sentence
            if (sentenceIndices.length > 0) {
                const firstSpan = document.querySelector('.sentence-group[data-sentence="' + sentenceIndices[0] + '"]');
                if (firstSpan) {
                    firstSpan.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            }
        }
        
        function highlightPosts(postIds, color) {
            // Clear previous highlights
            document.querySelectorAll('#grouped_posts .post-section').forEach(section => {
                section.classList.remove('range-highlight');
                section.style.backgroundColor = '';
                section.style.borderLeft = '';
            });
            
            // Highlight posts in this group
            postIds.forEach(postId => {
                const section = document.querySelector('[data-post-id="' + postId + '"]');
                if (section) {
                    section.classList.add('range-highlight');
                    section.style.backgroundColor = color + '40';
                    section.style.borderLeft = '3px solid ' + color;
                }
            });
            
            // Scroll to first post
            if (postIds.length > 0) {
                const target = document.querySelector('[data-post-id="' + postIds[0] + '"]');
                if (target) {
                    target.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            }
        }
    })();
</script>
<div id="progressbar"></div></body>
</html>