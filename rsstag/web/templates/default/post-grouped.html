<!DOCTYPE html />
<html>

<head>
    <title>Grouped Post | {{feed_title}}</title>
    {% include "head-data.html" %}
    <script type="text/javascript" src="/static/js/google-charts.js"></script>
    <script type="text/javascript" src="/static/js/d3.v6.min.js"></script>
    <style>
        .sentence-group {
            display: inline;
            margin: 0 1px;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .sentence-group:hover {
            filter: brightness(0.9);
        }

        .sentence-group.highlighted {
            outline: 2px solid #ff9800;
            box-shadow: 0 0 5px rgba(255, 152, 0, 0.8);
            font-weight: bold;
        }

        .post-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .post-header {
            margin-bottom: 12px;
        }

        .post-content {
            margin-top: 8px;
        }

        .post-label {
            display: inline-block;
            padding: 4px 12px;
            background-color: #4285f4;
            color: white;
            border-radius: 16px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .post-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #4285f4, transparent);
            margin: 6px 0;
        }

        .sentence {
            display: inline;
        }

        #segments_tree {
            font-family: monospace;
            font-size: 13px;
            line-height: 1.25em;
            padding: 8px;
            color: #000;
            border-radius: 6px;
            max-height: 400px;
            overflow: auto;
        }

        .seg-node {
            cursor: pointer;
            white-space: nowrap;
        }

        .seg-node .label {
            padding: 2px 4px;
            border-radius: 4px;
        }

        .seg-meta {
            opacity: 0.7;
            font-size: 11px;
            margin-left: 4px;
        }

        .legend {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid #999;
        }

        .depth-0 .label {
            font-weight: bold;
            font-size: 14px;
        }

        .collapsed>.children {
            display: none;
        }

        .children {
            margin-left: 18px;
            border-left: 1px dashed #555;
            padding-left: 6px;
        }

        .toggle {
            color: #6cf;
            margin-right: 4px;
        }

        .range-highlight {
            outline: 2px solid #ff9800;
            box-shadow: 0 0 3px 2px rgba(255, 152, 0, 0.6);
        }

        .pulse {
            animation: pulse-bg 1.5s ease-in-out 1;
        }

        @keyframes pulse-bg {
            0% {
                outline-color: #ff9800;
            }

            50% {
                outline-color: #ffc107;
            }

            100% {
                outline-color: #ff9800;
            }
        }

        .sticky-sidebar {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 6px;
            backdrop-filter: blur(5px);
        }

        .topic-item {
            margin: 4px 0;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .topic-item:hover {
            filter: brightness(0.9);
            transform: translateX(2px);
        }

        .topic-item.active {
            outline: 2px solid #333;
        }

        .topic-count {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 4px;
        }

        .section-header {
            font-weight: bold;
            margin: 15px 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .topic-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .topic-controls {
            display: flex;
            gap: 4px;
        }

        .topic-btn {
            border: 1px solid #999;
            background: #fff;
            color: #333;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .topic-btn:hover {
            background: #f0f0f0;
        }
    </style>
</head>

<body>
    {% import 'main-menu.html' as menu with context %}{% import 'global-status.html' as g_status with context %}

    <div id="global_tools">
        <div class="left_half">
            <div id="link_on_root" class="global_tools_button">
                <a href="/">main</a>
            </div>
            <div id="help_button" class="global_tools_button">
                <a href="#">help</a>
            </div>
        </div>
        <div class="right_half">
            <div id="player_block" class="global_tools_button"></div>
            <div id="posts_stat" class="global_tools_button"></div>
            <div id="read_all" class="global_tools_button"></div>
            <div id="show_all" class="global_tools_button"></div>
            {{ g_status.global_status() }}
            {{ menu.settings_menu() }}
        </div>
    </div>

    <div class="page">
        <h2>Posts {{post_id}} - {{feed_title}}</h2>

        <div style="margin-bottom: 20px;">
            <a href="/post-graph/{{post_id}}" class="topic-btn"
                style="text-decoration: none; padding: 6px 12px; font-size: 14px;">View Topics Graph</a>
        </div>

        {% if feed_title and feed_title != "Processing..." %}
        <div style="padding: 15px; background-color: #e8f5e9; border-radius: 5px; margin-bottom: 20px;">
            <p style="margin: 0; color: #2e7d32;">
                <strong>Combined view:</strong> {{ feed_title }}
                {% if sentences|length > 0 %}
                <span style="margin-left: 10px; font-weight: normal;">
                    ({{ sentences|length }} sentences from {{ groups|length }} topics)
                </span>
                {% endif %}
            </p>
        </div>
        {% endif %}

        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div style="flex:2 1 600px; min-width:400px;">
                <h3>Posts</h3>
                <div id="grouped_posts">
                    {% if posts|length > 0 %}
                    {% for post in posts %}
                    <div class="post-section" id="post_{{ post.post_id }}" data-post-id="{{ post.post_id }}">
                        <div class="post-header">
                            <span class="post-label">Post {{ post.post_id }}</span>
                            {% if post.feed_title %}
                            <span class="post-feed" style="margin-left: 10px; font-weight: normal; color: #666;">
                                from {{ post.feed_title }}
                            </span>
                            {% endif %}
                            <div class="post-divider"></div>
                        </div>
                        <div class="post-content">
                            <div class="post-text" data-post-id="{{ post.post_id }}">{{ post.content|safe }}</div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="no-posts-message" style="padding: 20px; text-align: center; color: #666;">
                        No posts found or posts are still being processed.
                    </div>
                    {% endif %}
                </div>
            </div>
            <div style="flex:1 1 320px; min-width:280px;">
                <div class="sticky-sidebar">
                    <div class="section-header">Topics/Chapters</div>
                    <div id="topics_list"></div>

                    {% if posts|length > 1 %}
                    <div class="section-header" style="margin-top: 20px;">Posts</div>
                    <div id="posts_list"></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        window.post_id = "{{post_id|default('')|string}}";
        window.feed_title = '{{feed_title|default('')|string}}';
        window.groups = {{ groups |default ({}) | tojson }};
        window.group_colors = {{ group_colors |default ({}) | tojson }};
        window.posts = {{ posts |default ([]) | tojson }};
        window.sentences = {{ sentences |default ([]) | tojson }};
        window.rss_settings = {{ user_settings |default ({}) | tojson }};
        window.hierarchical_segments = {{ hierarchical_segments |default ([]) | tojson }};
        window.post_to_index_map = {{ post_to_index_map |default ({}) | tojson }};
        window.has_grouped_data = {{ has_grouped_data |default (false) | tojson }};

        (function () {
            // Global state
            const topicState = {};
            let isContentReady = false;

            // Add data-post-id attributes to post sections
            document.querySelectorAll('#grouped_posts .post-section').forEach((section) => {
                const postId = section.getAttribute('data-post-id');
                if (postId) {
                    section.setAttribute('data-post-index', window.post_to_index_map[postId]);
                }
            });

            // Add hover effects to post sections for better visual feedback
            document.querySelectorAll('#grouped_posts .post-section').forEach((section) => {
                section.addEventListener('mouseenter', () => {
                    section.style.boxShadow = '0 2px 8px rgba(66, 133, 244, 0.2)';
                });
                section.addEventListener('mouseleave', () => {
                    section.style.boxShadow = 'none';
                });
            });

            // If we have grouped data with sentences, wrap content in sentence spans
            if (window.has_grouped_data && window.sentences && window.sentences.length > 0) {
                wrapSentencesInContent();
                isContentReady = true;
            } else {
                isContentReady = true;
            }

            // Build topics list
            const topicsList = document.getElementById('topics_list');
            const groupKeys = Object.keys(window.groups);

            if (groupKeys.length > 0) {
                groupKeys.forEach(groupName => {
                    const sentenceIndices = (window.groups[groupName] || []).slice().sort((a, b) => a - b);
                    const color = window.group_colors[groupName] || '#4a6baf';
                    const el = document.createElement('div');
                    el.className = 'topic-item';
                    el.style.backgroundColor = color + '40'; // add alpha
                    el.style.borderLeft = '4px solid ' + color;

                    // Display name, count and nav buttons
                    const countLabel = sentenceIndices.length;
                    const line = document.createElement('div');
                    line.className = 'topic-line';

                    const titleWrap = document.createElement('div');
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'topic-name';
                    nameSpan.textContent = groupName;
                    const countSpan = document.createElement('span');
                    countSpan.className = 'topic-count';
                    countSpan.textContent = '(' + countLabel + ')';
                    titleWrap.appendChild(nameSpan);
                    titleWrap.appendChild(countSpan);

                    const controls = document.createElement('div');
                    controls.className = 'topic-controls';
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'topic-btn topic-btn-prev';
                    prevBtn.title = 'Previous sentence';
                    prevBtn.textContent = 'Prev';
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'topic-btn topic-btn-next';
                    nextBtn.title = 'Next sentence';
                    nextBtn.textContent = 'Next';
                    controls.appendChild(prevBtn);
                    controls.appendChild(nextBtn);

                    line.appendChild(titleWrap);
                    line.appendChild(controls);
                    el.appendChild(line);

                    // Track sentence order per topic for navigation
                    topicState[groupName] = {
                        sentences: sentenceIndices,
                        index: 0,
                        color
                    };

                    el.onclick = () => {
                        if (!isContentReady) return;

                        // Clear previous active state
                        document.querySelectorAll('.topic-item.active').forEach(item => {
                            item.classList.remove('active');
                        });
                        el.classList.add('active');

                        if (window.has_grouped_data && topicState[groupName]) {
                            // Highlight sentences for this topic and scroll to the first
                            topicState[groupName].index = 0;
                            highlightSentences(sentenceIndices, color, 0);
                        } else {
                            // Fallback: highlight post sections
                            highlightPosts(sentenceIndices, color);
                        }
                    };

                    // Prev/Next buttons navigate within this topic sentences
                    prevBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        ev.preventDefault();
                        if (!isContentReady) return;

                        // Ensure topic stays active
                        document.querySelectorAll('.topic-item.active').forEach(item => {
                            item.classList.remove('active');
                        });
                        el.classList.add('active');

                        moveTopicPointer(groupName, -1);
                    });
                    nextBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        ev.preventDefault();
                        if (!isContentReady) return;

                        // Ensure topic stays active
                        document.querySelectorAll('.topic-item.active').forEach(item => {
                            item.classList.remove('active');
                        });
                        el.classList.add('active');

                        moveTopicPointer(groupName, 1);
                    });
                    topicsList.appendChild(el);
                });
            } else {
                topicsList.innerHTML = '<p style="color: #666; font-style: italic;">No topics available</p>';
            }

            // Build posts list (only shown when multiple posts)
            const postsList = document.getElementById('posts_list');
            if (postsList && window.posts.length > 1) {
                window.posts.forEach((post, idx) => {
                    const el = document.createElement('div');
                    el.className = 'topic-item';
                    el.style.backgroundColor = '#4285f440';
                    el.style.borderLeft = '4px solid #4285f4';
                    el.innerHTML = '<span class="topic-name">Post ' + post.post_id + '</span>' +
                        '<span class="topic-count">(' + (post.feed_title || 'Unknown') + ')</span>';
                    el.onclick = () => {
                        const section = document.querySelector('[data-post-id="' + post.post_id + '"]');
                        if (section) {
                            // Use setTimeout to ensure DOM is settled
                            setTimeout(() => {
                                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                // Flash highlight
                                section.classList.add('range-highlight', 'pulse');
                                setTimeout(() => {
                                    section.classList.remove('range-highlight', 'pulse');
                                }, 2000);
                            }, 50);
                        }
                    };
                    postsList.appendChild(el);
                });
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function wrapSentencesInContent() {
                // Group sentences by post_id
                const sentencesByPost = {};
                window.sentences.forEach(sentence => {
                    const postId = sentence.post_id;
                    if (!sentencesByPost[postId]) {
                        sentencesByPost[postId] = [];
                    }
                    sentencesByPost[postId].push(sentence);
                });

                // For each post, wrap its content with sentence spans
                Object.keys(sentencesByPost).forEach(postId => {
                    const postText = document.querySelector('.post-text[data-post-id="' + postId + '"]');
                    if (!postText) return;

                    const postSentences = sentencesByPost[postId];
                    let content = postText.innerHTML;

                    // Find colors for each sentence based on groups
                    const sentenceColors = {};
                    Object.keys(window.groups).forEach(groupName => {
                        const color = window.group_colors[groupName] || '#4a6baf';
                        window.groups[groupName].forEach(sentNum => {
                            sentenceColors[sentNum] = color;
                        });
                    });

                    // Sort sentences by length descending to avoid partial replacements
                    const sortedSentences = [...postSentences].sort((a, b) => b.text.length - a.text.length);

                    // Track which parts of content have been wrapped
                    const wrappedRanges = [];

                    sortedSentences.forEach(sentence => {
                        const sentText = sentence.text;
                        const sentNum = sentence.number;
                        const color = sentenceColors[sentNum] || '#f0f0f0';

                        // Find the sentence in content (handle HTML)
                        // First try exact match
                        let idx = content.indexOf(sentText);

                        if (idx === -1) {
                            // Try with normalized whitespace
                            const normalizedSent = sentText.replace(/\s+/g, ' ').trim();
                            const normalizedContent = content.replace(/\s+/g, ' ');
                            idx = normalizedContent.indexOf(normalizedSent);
                        }

                        if (idx !== -1) {
                            // Check if this range overlaps with already wrapped ranges
                            const endIdx = idx + sentText.length;
                            const overlaps = wrappedRanges.some(range =>
                                (idx >= range.start && idx < range.end) ||
                                (endIdx > range.start && endIdx <= range.end)
                            );

                            if (!overlaps) {
                                const before = content.substring(0, idx);
                                const after = content.substring(idx + sentText.length);
                                const wrapped = '<span class="sentence-group" data-sentence="' + sentNum +
                                    '" style="background-color: ' + color + '40;">' +
                                    sentText + '</span>';
                                content = before + wrapped + after;

                                // Update wrapped ranges (accounting for added HTML)
                                const addedLength = wrapped.length - sentText.length;
                                wrappedRanges.forEach(range => {
                                    if (range.start > idx) {
                                        range.start += addedLength;
                                        range.end += addedLength;
                                    }
                                });
                                wrappedRanges.push({ start: idx, end: idx + wrapped.length });
                            }
                        }
                    });

                    postText.innerHTML = content;
                });

                // Add click handlers to sentence spans
                document.querySelectorAll('.sentence-group').forEach(span => {
                    span.addEventListener('click', function (ev) {
                        ev.stopPropagation();
                        const sentNum = parseInt(this.getAttribute('data-sentence'));
                        if (!sentNum) return;

                        // Find which topic this sentence belongs to
                        let topicName = null;
                        let topicElement = null;

                        Object.keys(window.groups).forEach(groupName => {
                            if (window.groups[groupName].includes(sentNum)) {
                                topicName = groupName;
                            }
                        });

                        if (topicName) {
                            // Find and trigger the topic element
                            const topicItems = document.querySelectorAll('.topic-item');
                            for (let item of topicItems) {
                                const nameEl = item.querySelector('.topic-name');
                                if (nameEl && nameEl.textContent.trim() === topicName) {
                                    topicElement = item;
                                    break;
                                }
                            }

                            if (topicElement && typeof topicElement.onclick === 'function') {
                                topicElement.onclick();
                            }
                        }
                    });
                });
            }

            function highlightSentences(sentenceIndices, color, focusIndex) {
                if (!sentenceIndices || sentenceIndices.length === 0) return;

                // Clear previous highlights
                document.querySelectorAll('.sentence-group.highlighted').forEach(span => {
                    span.classList.remove('highlighted');
                });

                // Highlight sentences in the list
                const highlightedElements = [];
                sentenceIndices.forEach(sentNum => {
                    const span = document.querySelector('.sentence-group[data-sentence="' + sentNum + '"]');
                    if (span) {
                        span.classList.add('highlighted');
                        highlightedElements.push(span);
                    }
                });

                // Scroll to the specified sentence
                if (highlightedElements.length > 0) {
                    const targetIdx = Number.isFinite(focusIndex) ? Math.max(0, Math.min(highlightedElements.length - 1, focusIndex)) : 0;
                    const targetSpan = highlightedElements[targetIdx];
                    if (targetSpan) {
                        // Use setTimeout to ensure DOM updates are complete
                        setTimeout(() => {
                            targetSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            targetSpan.classList.add('pulse');
                            setTimeout(() => targetSpan.classList.remove('pulse'), 1200);
                        }, 100);
                    }
                }
            }

            function highlightPosts(postIds, color) {
                if (!postIds || postIds.length === 0) return;

                // Clear previous highlights
                document.querySelectorAll('#grouped_posts .post-section').forEach(section => {
                    section.classList.remove('range-highlight');
                    section.style.backgroundColor = '';
                    section.style.borderLeft = '';
                });

                // Highlight posts in this group
                const highlightedSections = [];
                postIds.forEach(postId => {
                    const section = document.querySelector('[data-post-id="' + postId + '"]');
                    if (section) {
                        section.classList.add('range-highlight');
                        section.style.backgroundColor = color + '40';
                        section.style.borderLeft = '3px solid ' + color;
                        highlightedSections.push(section);
                    }
                });

                // Scroll to first post
                if (highlightedSections.length > 0) {
                    const target = highlightedSections[0];
                    // Use setTimeout to ensure DOM updates are complete
                    setTimeout(() => {
                        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }

            function moveTopicPointer(topicName, delta) {
                const state = topicState[topicName];
                if (!state) return;

                if (!state.sentences || state.sentences.length === 0) {
                    // Fallback: if there is no sentence data, try to highlight posts for this group
                    if (!window.has_grouped_data && window.groups[topicName]) {
                        highlightPosts(window.groups[topicName], state.color || '#4a6baf');
                    }
                    return;
                }

                const total = state.sentences.length;
                // Wrap around the index
                state.index = ((state.index + delta) % total + total) % total;

                if (window.has_grouped_data) {
                    highlightSentences(state.sentences, state.color, state.index);
                } else {
                    highlightPosts(state.sentences, state.color);
                }
            }

            // Handle highlight_sentence from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const highlightSentNum = parseInt(urlParams.get('highlight_sentence'));
            if (!isNaN(highlightSentNum)) {
                // Find which topic this sentence belongs to for color
                let topicName = null;
                Object.keys(window.groups).forEach(name => {
                    if (window.groups[name].includes(highlightSentNum)) {
                        topicName = name;
                    }
                });

                if (topicName && isContentReady) {
                    const color = window.group_colors[topicName] || '#4a6baf';
                    // Wait a bit for content to be fully ready and wrapped
                    setTimeout(() => {
                        highlightSentences([highlightSentNum], color, 0);

                        // Also activate the topic in the sidebar
                        const topicItems = document.querySelectorAll('.topic-item');
                        for (let item of topicItems) {
                            const nameEl = item.querySelector('.topic-name');
                            if (nameEl && nameEl.textContent.trim() === topicName) {
                                item.classList.add('active');
                                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                break;
                            }
                        }
                    }, 500);
                }
            }
        })();
    </script>
    <div id="progressbar"></div>
</body>

</html>