<html>

<head>
    <title>Topics/Chapters List</title>
    {% include "head-data.html" %}
</head>

<body>
    {% import 'main-menu.html' as menu with context %}{% import 'global-status.html' as g_status with context %}

    <div id="global_tools">
        <div class="left_half">
            <div id="link_on_root" class="global_tools_button">
                <a href="/">main</a>
            </div>
            <div id="help_button" class="global_tools_button">
                <a href="#">help</a>
            </div>
        </div>
        <div class="right_half">
            {{ g_status.global_status() }}
            {{ menu.settings_menu() }}
        </div>
    </div>

    <div class="page">
        <h1>Topics/Chapters List</h1>

        <div id="topics_list_container">
            <div class="topics-cloud">
                {% for topic_name, topic_data in topics %}
                <div class="topic-item">
                    <div class="topic-header">
                        {% set all_post_ids = topic_data.posts|join('_') %}
                        <a href="/post-grouped/{{ all_post_ids }}" class="topic-link" title="{{ topic_name }}">{{
                            topic_name[:60] }}{% if topic_name|length > 60 %}...{% endif %}</a>
                        <a href="/post-grouped-snippets/{{ all_post_ids }}?topic={{ topic_name }}" class="snippet-link"
                            title="View snippets">S</a>
                        <span class="topic-count">({{ topic_data.count }})</span>
                        {% if topic_data.posts|length > 0 %}
                        <button class="toggle-posts" onclick="togglePosts('{{ loop.index }}')">[{{
                            topic_data.posts|length }} posts]</button>
                        {% endif %}
                    </div>
                    {% if topic_data.posts|length > 0 %}
                    <div class="topic-posts" id="posts_{{ loop.index }}" style="display: none;">
                        {% for post_id in topic_data.posts %}
                        {% set post_info = post_topic_mapping[post_id] %}
                        <div class="post-info">
                            <a href="/post-grouped/{{ post_id }}" title="{{ post_info.feed_title }}">{{
                                post_info.feed_title[:40] }}{% if post_info.feed_title|length > 40 %}...{% endif %}</a>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

    </div>

    <div id="global_tools_bottom">
        <ul id="paginator">
            {% if pages_map['start'] %}
            {% for number in pages_map['start'] %}
            {% if number['p'] == current_page %}
            <li class="current_page">{{number['p']}}</li>
            {% else %}
            <li><a href="{{number['url']}}">{{number['p']}}</a></li>
            {% endif %}
            {% endfor %}
            {% if pages_map['middle'] %}
            <li>....</li>
            {% endif %}
            {% endif %}
            {% if pages_map['middle'] %}
            {% for number in pages_map['middle'] %}
            {% if number['p'] == current_page %}
            <li class="current_page">{{number['p']}}</li>
            {% else %}
            <li><a href="{{number['url']}}">{{number['p']}}</a></li>
            {% endif %}
            {% endfor %}
            {% endif %}
            {% if pages_map['end'] %}
            <li>....</li>
            {% for number in pages_map['end'] %}
            {% if number['p'] == current_page %}
            <li class="current_page">{{number['p']}}</li>
            {% else %}
            <li><a href="{{number['url']}}">{{number['p']}}</a></li>
            {% endif %}
            {% endfor %}
            {% endif %}
        </ul>
    </div>

    <style>
        .topics-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .topic-item {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 14px;
            flex: 1 1 calc(33% - 16px);
            min-width: 250px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .topic-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .topic-link {
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
            flex: 1;
            min-width: 150px;
        }

        .topic-link:hover {
            text-decoration: underline;
        }

        .snippet-link {
            display: inline-block;
            padding: 2px 6px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            text-decoration: none;
            font-size: 11px;
            margin-right: 6px;
            font-weight: bold;
        }

        .snippet-link:hover {
            background: #bbdefb;
        }

        .topic-count {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
        }

        .toggle-posts {
            background: none;
            border: none;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .toggle-posts:hover {
            background-color: #e9ecef;
        }

        .topic-posts {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #e9ecef;
            font-size: 13px;
        }

        .post-info {
            margin-bottom: 4px;
        }

        .post-info a {
            color: #495057;
            text-decoration: none;
            font-size: 12px;
            display: block;
        }

        .post-info a:hover {
            text-decoration: underline;
        }

        .topic-item:hover {
            background-color: #f1f3f5;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .topic-item {
                flex: 1 1 100%;
            }
        }
    </style>

    <script>
        function togglePosts(index) {
            const postsElement = document.getElementById('posts_' + index);
            const button = event.target;

            if (postsElement.style.display === 'none') {
                postsElement.style.display = 'block';
                button.textContent = button.textContent.replace('[', '[-');
            } else {
                postsElement.style.display = 'none';
                button.textContent = button.textContent.replace('[-', '[');
            }
        }
    </script>

</body>

</html>