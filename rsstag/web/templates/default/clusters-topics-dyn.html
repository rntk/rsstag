<!DOCTYPE html>
<html>

<head>
    <title>Clusters Topics dynamic</title>
    {% include "head-data.html" %}
</head>

<body>
    {% import 'main-menu.html' as menu with context %}{% import 'global-status.html' as g_status with context %}

    <div id="global_tools">
        <div class="left_half">
            <div id="link_on_root" class="global_tools_button">
                <a href="/">main</a>
            </div>
            <div id="help_button" class="global_tools_button">
                <a href="#">help</a>
            </div>
        </div>
        <div class="right_half">
            {{ g_status.global_status() }}
            {{ menu.settings_menu() }}
        </div>
    </div>

    <div class="page">
        <div class="clusters-topics-page">
            {% if clusters %}
            <div class="clusters-topics-list">
                {% for cluster in clusters %}
                <button class="clusters-topic-item" data-cluster="{{ cluster.id }}" type="button">
                    <span class="clusters-topic-title">{{ cluster.title }}</span>
                    <span class="clusters-topic-count">{{ cluster.count }}</span>
                </button>
                {% endfor %}
            </div>
            <div class="clusters-topic-sentences" id="clusters-topic-sentences">
                <div class="clusters-topic-placeholder">Select a cluster to load sentences.</div>
            </div>
            {% else %}
            <p>No clusters</p>
            {% endif %}
        </div>
    </div>

    <script id="clusters-topics-data" type="application/json">{{ clusters_data|tojson }}</script>
    <script>
        (function () {
            var dataEl = document.getElementById("clusters-topics-data");
            if (!dataEl) {
                return;
            }
            var clusterData = {};
            try {
                clusterData = JSON.parse(dataEl.textContent || "{}");
            } catch (err) {
                clusterData = {};
            }

            var items = document.querySelectorAll(".clusters-topic-item");
            var sentencesEl = document.getElementById("clusters-topic-sentences");
            var currentRanges = [];
            if (!items.length || !sentencesEl) {
                return;
            }

            function escapeHtml(value) {
                return String(value)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/\"/g, "&quot;")
                    .replace(/'/g, "&#39;");
            }

            function buildRangeKey(postId, sentenceIndices) {
                var base = String(postId);
                if (!sentenceIndices || !sentenceIndices.length) {
                    return base;
                }
                return base + "_" + sentenceIndices.join("_");
            }

            function parseSentenceIndices(value) {
                if (!value) {
                    return [];
                }
                var parts = String(value).split(",");
                var result = [];
                for (var i = 0; i < parts.length; i += 1) {
                    var num = Number(parts[i]);
                    if (!isNaN(num)) {
                        result.push(num);
                    }
                }
                return result;
            }

            function renderRanges(ranges, title) {
                var html = [];
                currentRanges = Array.isArray(ranges) ? ranges : [];
                html.push('<div class="clusters-topic-header">' + escapeHtml(title) + '</div>');
                if (!currentRanges.length) {
                    html.push('<div class="clusters-topic-placeholder">No ranges found.</div>');
                    sentencesEl.innerHTML = html.join("");
                    updateReadControlsState();
                    return;
                }
                html.push(
                    '<div class="clusters-topic-toolbar">' +
                    '<button class="clusters-read-btn" data-action="read-all" type="button">Read all</button>' +
                    '<button class="clusters-read-btn" data-action="unread-all" type="button">Unread all</button>' +
                    '</div>'
                );
                html.push('<div class="clusters-topic-sentences-list">');
                for (var i = 0; i < currentRanges.length; i += 1) {
                    var range = currentRanges[i];
                    var meta = 'Post ' + range.post_id;
                    if (range.topic_title) {
                        meta += ' | ' + range.topic_title;
                    }
                    var sentenceIndices = Array.isArray(range.sentence_indices)
                        ? range.sentence_indices
                        : [];
                    var isRead = !!range.read;
                    var readClass = isRead ? 'is-read' : 'is-unread';
                    var readLabel = isRead ? 'Mark Unread' : 'Mark Read';
                    var readTitle = isRead ? 'Mark as unread' : 'Mark as read';
                    var rangeKey = buildRangeKey(range.post_id, sentenceIndices);
                    var readBtn = '<button class="clusters-topic-toggle-read" data-post-id="' +
                        escapeHtml(range.post_id) + '" data-sentence-indices="' +
                        escapeHtml(sentenceIndices.join(",")) + '" data-range-key="' +
                        escapeHtml(rangeKey) + '" data-read="' + (isRead ? '1' : '0') +
                        '" type="button" title="' + readTitle + '">' + readLabel + '</button>';
                    var postLink = "";
                    if (range.post_id !== undefined && range.post_id !== null) {
                        postLink = '<a class="clusters-topic-sentence-link" href="/posts/' +
                            encodeURIComponent(range.post_id) + '">Open post</a>';
                    }
                    html.push(
                        '<div class="clusters-topic-sentence ' + readClass + '" data-post-id="' +
                        escapeHtml(range.post_id) + '" data-sentence-indices="' +
                        escapeHtml(sentenceIndices.join(",")) + '" data-range-key="' +
                        escapeHtml(rangeKey) + '">' +
                        '<div class="clusters-topic-sentence-meta">' + escapeHtml(meta) + '</div>' +
                        '<div class="clusters-topic-sentence-text">' + escapeHtml(range.text) + '</div>' +
                        '<div class="clusters-topic-sentence-actions">' +
                        readBtn +
                        postLink +
                        '</div>' +
                        '</div>'
                    );
                }
                html.push('</div>');
                sentencesEl.innerHTML = html.join("");
                updateReadControlsState();
            }

            function setActive(el) {
                for (var i = 0; i < items.length; i += 1) {
                    items[i].classList.remove("is-active");
                }
                el.classList.add("is-active");
            }

            function requestSentences(clusterId) {
                var cluster = clusterData[String(clusterId)];
                if (!cluster || !cluster.ranges) {
                    renderRanges([], "Cluster");
                    return;
                }
                sentencesEl.classList.add("is-loading");
                sentencesEl.innerHTML = '<div class="clusters-topic-placeholder">Loading...</div>';
                fetch("/clusters-topics-dyn-sentences", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        ranges: cluster.ranges
                    })
                }).then(function (response) {
                    return response.json();
                }).then(function (payload) {
                    var items = payload && payload.ranges ? payload.ranges : [];
                    renderRanges(items, cluster.title || "Cluster");
                }).catch(function () {
                    renderRanges([], "Cluster");
                }).finally(function () {
                    sentencesEl.classList.remove("is-loading");
                });
            }

            function updateReadControlsState() {
                var disabled = !currentRanges.length;
                var buttons = sentencesEl.querySelectorAll('.clusters-read-btn');
                for (var i = 0; i < buttons.length; i += 1) {
                    buttons[i].disabled = disabled;
                }
            }

            function updateRangeReadState(rangeKey, isRead) {
                for (var i = 0; i < currentRanges.length; i += 1) {
                    var currentRange = currentRanges[i];
                    var currentKey = buildRangeKey(
                        currentRange.post_id,
                        currentRange.sentence_indices || []
                    );
                    if (String(currentKey) === String(rangeKey)) {
                        currentRanges[i].read = isRead;
                    }
                }
                var nodes = sentencesEl.querySelectorAll(
                    '.clusters-topic-sentence[data-range-key="' + String(rangeKey) + '"]'
                );
                for (var j = 0; j < nodes.length; j += 1) {
                    var node = nodes[j];
                    node.classList.toggle('is-read', isRead);
                    node.classList.toggle('is-unread', !isRead);
                    var btn = node.querySelector('.clusters-topic-toggle-read');
                    if (btn) {
                        btn.textContent = isRead ? 'Mark Unread' : 'Mark Read';
                        btn.title = isRead ? 'Mark as unread' : 'Mark as read';
                        btn.setAttribute('data-read', isRead ? '1' : '0');
                    }
                }
            }

            function changeSnippetsStatus(selections, readed) {
                var requests = [];
                for (var i = 0; i < selections.length; i += 1) {
                    var selection = selections[i];
                    var sentenceIndices = selection.sentenceIndices || [];
                    for (var j = 0; j < sentenceIndices.length; j += 1) {
                        requests.push(
                            fetch('/read/snippet', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    post_id: selection.postId,
                                    sentence_index: sentenceIndices[j],
                                    readed: readed
                                })
                            }).then(function (response) {
                                return response.json();
                            })
                        );
                    }
                }
                return Promise.all(requests);
            }

            function normalizePostId(value) {
                var numeric = Number(value);
                if (!isNaN(numeric)) {
                    return numeric;
                }
                return value;
            }

            function getRangeSelections() {
                var selections = [];
                for (var i = 0; i < currentRanges.length; i += 1) {
                    var range = currentRanges[i];
                    var pid = range.post_id;
                    var sentenceIndices = Array.isArray(range.sentence_indices)
                        ? range.sentence_indices
                        : [];
                    if (pid === undefined || pid === null || !sentenceIndices.length) {
                        continue;
                    }
                    selections.push({
                        postId: pid,
                        sentenceIndices: sentenceIndices,
                        rangeKey: buildRangeKey(pid, sentenceIndices)
                    });
                }
                return selections;
            }

            sentencesEl.addEventListener('click', function (evt) {
                var target = evt.target;
                if (target.classList.contains('clusters-read-btn')) {
                    var action = target.getAttribute('data-action');
                    var readed = action === 'read-all';
                    var selections = getRangeSelections();
                    if (!selections.length) {
                        return;
                    }
                    changeSnippetsStatus(selections, readed).then(function (payloads) {
                        var allOk = payloads.length && payloads.every(function (payload) {
                            return payload && payload.data === 'ok';
                        });
                        if (allOk) {
                            for (var i = 0; i < selections.length; i += 1) {
                                updateRangeReadState(selections[i].rangeKey, readed);
                            }
                        } else {
                            alert('Failed to update snippet status');
                        }
                    }).catch(function () {
                        alert('Failed to update snippet status');
                    });
                    return;
                }
                if (!target.classList.contains('clusters-topic-toggle-read')) {
                    return;
                }
                var postId = normalizePostId(target.getAttribute('data-post-id'));
                var isRead = target.getAttribute('data-read') === '1';
                var sentenceIndices = parseSentenceIndices(
                    target.getAttribute('data-sentence-indices')
                );
                var rangeKey = target.getAttribute('data-range-key');
                var nextRead = !isRead;
                if (!postId || !sentenceIndices.length) {
                    return;
                }
                changeSnippetsStatus([{
                    postId: postId,
                    sentenceIndices: sentenceIndices,
                    rangeKey: rangeKey
                }], nextRead).then(function (payloads) {
                    var allOk = payloads.length && payloads.every(function (payload) {
                        return payload && payload.data === 'ok';
                    });
                    if (allOk) {
                        updateRangeReadState(rangeKey, nextRead);
                    } else {
                        alert('Failed to update snippet status');
                    }
                }).catch(function () {
                    alert('Failed to update snippet status');
                });
            });

            for (var i = 0; i < items.length; i += 1) {
                items[i].addEventListener("click", function (evt) {
                    var clusterId = evt.currentTarget.getAttribute("data-cluster");
                    setActive(evt.currentTarget);
                    requestSentences(clusterId);
                });
            }
        })();
    </script>

    <div id="progressbar"></div>
</body>

</html>
